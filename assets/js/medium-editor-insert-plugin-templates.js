;(function($,window,document,undefined){'use strict';var pluginName='mediumInsert',addonName='Templates';function Templates(el,options){this.el=el;this.$el=$(el);this.templates=window.MediumInsert.Templates;this.core=this.$el.data('plugin_'+pluginName);var defaults={id:'1',label:'<i class="material-icons">data_object</i>',diffLeft:0,diffTop:-20,standardizeSelectionStart:false,container:$('#news .feature'),scrollContainer:$('.news'),renderButton:renderTemplatesButton,showButton:showTemplatesButton,hideButton:hideTemplatesButton,isButtonVisible:isButtonVisible,renderToolbar:renderTemplatesToolbar,showToolbar:showTemplatesToolbar,hideToolbar:hideTemplatesToolbar,isToolbarVisible:isToolbarVisible,showToolbarInput:showTemplatesToolbarInput};this.options=$.extend(true,{},defaults,options);this._defaults=defaults;this._name=pluginName;this.init();}
Templates.prototype.init=function(){this.events();};Templates.prototype.events=function(){};Templates.prototype.getCore=function(){return this.core;};Templates.prototype.add=function(){this.getCore().hideAddons();this.setToolbarPosition();};Templates.prototype.init=function(){MediumEditor.Extension.prototype.init.apply(this,arguments);this.initThrottledMethods();this.options.container.append(this.getToolbarElement());},Templates.prototype.forEachExtension=function(iterator,context){return this.base.extensions.forEach(function(command){if(command===this){return;}
return iterator.apply(context||this,arguments);},this);},Templates.prototype.createToolbar=function(){var toolbar=this.options.renderToolbar(this.options.id,this.handleFieldSelection.bind(this));this.attachEventHandlers();return toolbar[0];},Templates.prototype.destroy=function(){if(this.toolbar){if(this.toolbar.parentNode){this.toolbar.parentNode.removeChild(this.toolbar);}
delete this.toolbar;}},Templates.prototype.getActiveEditorElement=function(){return this.$el;},Templates.prototype.getInteractionElements=function(){return this.getToolbarElement();},Templates.prototype.getToolbarElement=function(){if(!this.toolbar){this.toolbar=this.createToolbar();}
return this.toolbar;},Templates.prototype.getButtonElement=function(){return $('button[data-addon="Templates"]')[0];}
Templates.prototype.getToolbarActionsElement=function(){return this.getToolbarElement().querySelector('.medium-editor-templates-toolbar-actions');},Templates.prototype.initThrottledMethods=function(){this.throttledPositionToolbar=MediumEditor.util.throttle(function(){this.positionToolbarIfShown();}.bind(this));},Templates.prototype.attachEventHandlers=function(){if(!!this.eventHandlersAttached){return;}
this.eventHandlersAttached=true;this.$el.on('blur',this.handleBlur.bind(this));this.$el.on('focus',this.handleFocus.bind(this));this.$el.on('editableClick',this.handleEditableClick.bind(this));this.$el.on('editableKeyup',this.handleEditableKeyup.bind(this));$(document.documentElement).on('mouseup',this.handleDocumentMouseup.bind(this));$(window).on('resize',this.handleWindowResize.bind(this));},Templates.prototype.handleWindowResize=function(){this.throttledPositionToolbar();},Templates.prototype.handleDocumentMouseup=function(event){if(event&&event.target&&(MediumEditor.util.isDescendant(this.getToolbarElement(),event.target)||MediumEditor.util.isDescendant(this.getButtonElement(),event.target))){return false;}
this.checkState();},Templates.prototype.handleEditableClick=function(event){var target=$(event.target);if(target.closest('button[data-addon="Templates"]').length>0){return;}
setTimeout(function(){this.checkState();}.bind(this),0);},Templates.prototype.handleEditableKeyup=function(){this.checkState();},Templates.prototype.handleBlur=function(){clearTimeout(this.hideTimeout);clearTimeout(this.delayShowTimeout);this.hideTemplatesToolbar();},Templates.prototype.handleFocus=function(){this.checkState();},Templates.prototype.handleFieldSelection=function(element){if(typeof _canUseTemplates!=='undefined'&&_canUseTemplates){var field=element.attr('data-field');var fieldTemplate='${'+field+'} ';var textNode=this.insertTextAtCursor(fieldTemplate);this.showToolbarDefaultInput(element.attr('data-name'),textNode);}else{this.hideTemplatesToolbar();displayProPlanBlock('dynamic content');}},Templates.prototype.insertTextAtCursor=function(text){if(!!this.currentRange){var textNode=document.createTextNode(text);this.currentRange.insertNode(textNode);this.currentSelection.collapse(textNode,text.length);return textNode;}},Templates.prototype.isDisplayed=function(){return this.options.isToolbarVisible(this.getToolbarElement());},Templates.prototype.showTemplatesToolbar=function(){clearTimeout(this.hideTimeout);if(!this.isDisplayed()){this.opening=true;this.options.showToolbar(this.getToolbarElement());var self=this;setTimeout(function(){$(self.getToolbarElement()).find('input.search').focus();self.opening=false;},300);}},Templates.prototype.hideTemplatesToolbar=function(){if(this.isDisplayed()&&!this.opening){this.options.hideToolbar(this.getToolbarElement());if(!$(this.getActiveEditorElement()).is(':focus')&&!!this.currentRange&&!!this.currentSelection){try{var node=this.currentRange.endContainer;this.currentSelection.collapse(node,node.textContent.length);}catch(e){}}
delete this.currentRange;delete this.currentSelection;this.hideTemplatesToolbar();}},Templates.prototype.showToolbarDefaultInput=function(placeholder,textNode){var self=this;var originalText=$(textNode).text();var closingIndex=originalText.indexOf('}');var toolbar=$(this.getToolbarElement());var input=toolbar.find('#medium-editor-templates-toolbar-input-field').unbind('keyup').on('keyup',function(e){var key='which'in e?e.which:e.keyCode;if(key===13){self.hideTemplatesToolbar();}else{var defaultValue=$(this).val();if(defaultValue!=''){var text=originalText.substring(0,closingIndex)
+';'+defaultValue
+originalText.substring(closingIndex,originalText.length);textNode.textContent=text;}else{textNode.textContent=originalText;}}});input.attr('placeholder',placeholder);this.options.showToolbarInput(toolbar);this.setToolbarPosition();setTimeout(function(){input.focus();},50);},Templates.prototype.modifySelection=function(){var selection=window.getSelection(),selectionRange=selection.getRangeAt(0);if(this.options.standardizeSelectionStart&&selectionRange.startContainer.nodeValue&&(selectionRange.startOffset===selectionRange.startContainer.nodeValue.length)){var adjacentNode=MediumEditor.util.findAdjacentTextNodeWithContent(MediumEditor.selection.getSelectionElement(window),selectionRange.startContainer,document);if(adjacentNode){var offset=0;while(adjacentNode.nodeValue.substr(offset,1).trim().length===0){offset=offset+1;}
selectionRange=MediumEditor.selection.select(document,adjacentNode,offset,selectionRange.endContainer,selectionRange.endOffset);}}},Templates.prototype.checkState=function(){return this.hideTemplatesToolbar();},Templates.prototype.positionToolbarIfShown=function(){if(this.isDisplayed()){this.setToolbarPosition();}},Templates.prototype.setToolbarPosition=function(){var container=this.getActiveEditorElement(),selection=window.getSelection();if(!selection||container.find(selection.focusNode).length===0){return;}
this.showTemplatesToolbar();this.positionToolbar(selection);},Templates.prototype.positionToolbar=function(selection){if(!this.currentRange||!this.currentSelection){var range=selection.getRangeAt(0);}else{var range=this.currentRange;selection=this.currentSelection;}
var toolbarElement=this.getToolbarElement(),toolbarHeight=toolbarElement.offsetHeight,buttonHeight=20,boundary=range.getBoundingClientRect(),toolbarBoundary=toolbarElement.getBoundingClientRect(),toolbarParentBoundary=toolbarElement.parentElement.getBoundingClientRect();if(boundary.top===0&&boundary.left===0){boundary=range.startContainer.getBoundingClientRect();}
var positions={top:boundary.top-toolbarParentBoundary.top-toolbarBoundary.height-this.options.diffTop,left:boundary.left-toolbarParentBoundary.left+boundary.width/2-toolbarBoundary.width/2};if(boundary.top<(toolbarHeight+buttonHeight)){toolbarElement.classList.add('medium-toolbar-arrow-over');toolbarElement.classList.remove('medium-toolbar-arrow-under');positions.top+=toolbarHeight+boundary.height-this.options.diffTop;}else{toolbarElement.classList.add('medium-toolbar-arrow-under');toolbarElement.classList.remove('medium-toolbar-arrow-over');positions.top+=this.options.diffTop;}
['top','left','right'].forEach(function(key){toolbarElement.style[key]=positions[key]+(isNaN(positions[key])?'':'px');});this.currentSelection=selection;this.currentRange=range;}
$.fn[pluginName+addonName]=function(options){return this.each(function(){if(!$.data(this,'plugin_'+pluginName+addonName)){$.data(this,'plugin_'+pluginName+addonName,new Templates(this,options));}});};})(jQuery,window,document);